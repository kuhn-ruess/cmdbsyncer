{% extends 'admin/master.html' %}
{% block body %}
<div class="container">
  <h2>Debug Host</h2>
  <form mehtod=GET>
    <div class="form-group">
      <label for="hostname">Hostname</label>
      <input name="hostname" class="form-control" id="hostname" aria-describedby="hostnameHelp" placeholder="Hostname" value={{hostname}}>
      <small id="hostnameHelp" class="form-text text-muted">Enter the Hostname for which you want to see the rule analysis</small>
    </div>
    <div class="form-group">
      <label for="inputTarget">Debug Target</label>
      <select id="inputTarget" name="mode" class="form-control">
        {% if mode %}
          <option value="{{mode}}" selected>Currently {{mode}}</option>
        {% else %}
          <option value="checkmk_host" selected>Choose...</option>
        {% endif %}
        <option value="checkmk_host">Checkmk Host</option>
        <option value="netbox_device">Netbox Device</option>
      </select>
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
  </form>

  {% if output is mapping%}
  <br>


<h2>Rules</h2>
  {% set condition_types = {
    'equal': "is equal",
    'in': "contains",
    'not_in': "not contains",
    'in_list': "found in given list",
    'string_in_list': "found in list",
    'ewith': "endswith",
    'swith': "startswith",
    'regex': "regex match",
    'bool': "Boolean",
    'ignore': "always match"
  } %}
  {% set negate = {
    true: 'not ',
    false: ' ',
  } %}
  <div id="accordion-export">
   <p>
    {% for rule_name in rules.keys() %}
     <a class="btn btn-info" data-toggle="collapse" href="#rule_{{rule_name}}" role="button" aria-expanded="false" aria-controls="rule_{{rule_name}}">{{rule_name.capitalize()}}</a>
   {% endfor %}
   </p>

    {% for rule_name, rule_raw in rules.items() %}
    <div class="card">
    <div class="card-header">
    Rule: {{ rule_name.capitalize() }}
    </div>
    <div class="card-body collapse" id="rule_{{rule_name}}" data-parent="#accordion-export">
    <table class="table table-bordered">
      <thead>
         <tr>
           <th scope="col" style="width:300px">Rule Name</th>
	   <th scope="col">Hit</th>
	   <th scope="col">First reason the rule wont match</th>
	   <th scope="col">Condition Type</th>
	   <th scope="col">Last Match</th>
      </tr>
      </thead>
      <tbody>
      {% for rule in rule_raw %}
         <tr {% if rule['hit'] %} class="table-success" {%endif%}>
           <td><a href="{{rule['rule_url']}}">{{rule['name']}}</a></td>
           <td>{{rule['hit']}}</td>
           {% if rule['no_match_reason'] %}
           <td>
            {% set no_match = rule['no_match_reason'] %}
            {% if no_match['match_type'] == 'host' %}
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Hostname</h6>
                    <p class="card-text">
                     <span class="badge badge-primary">
                     {{negate[no_match['hostname_match_negate']]}}
                     {{condition_types[no_match['hostname_match']]}}</span>
                    <span class="badge badge-info">{{no_match['hostname']}}</span>
                    </p>
                  </div>
                </div>
            {% else %}
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Key</h6>
                    <p class="card-text">
                     <span class="badge badge-primary">
                        {{ negate[no_match['tag_match_negate']] }} {{condition_types[no_match['tag_match']]}}
                     </span>
                     <span class="badge badge-info">{{ no_match['tag']}}</span>
                    </p>
                    <h6 class="card-subtitle mb-2 text-muted">Value</h6>
                    <p class="card-text">
                    <span class="badge badge-primary">
                        {{negate[no_match['value_match_negate']]}} {{condition_types[no_match['value_match']]}}
                    </span>
                    <span class="badge badge-info">{{no_match['value']}}</span>
                    </p>
                  </div>
                </div>
            {% endif %}
           </td>
           {% else %}
           <td></td>
           {%endif%}
           <td>{{rule['condition_type']}}</td>
           <td>{{rule['last_match']}}</td>
         </tr>
	 {% endfor %}
      </tbody>
    </table>
    </div>
    </div>
  {% endfor %}
  </div>
  
<h2>Attributes</h2>
<div id="accordion-attributes">
<p>
    {% for header in output.keys() %}
     <a class="btn btn-info" data-toggle="collapse" href="#rule_{{header.replace(' ',"_")}}" role="button" aria-expanded="true" aria-controls="rule_{{header.replace(' ', "_")}}">{{header.capitalize()}}</a>
   {% endfor %}
 </p>

  {% for header, content in output.items() %}
    <div class="card">
    <div class="card-header">
    {{ header }}
    </div>
    <div class="card-body collapse" id="rule_{{header.replace(' ', "_")}}" data-parent="#accordion-attributes">
    {%if content is mapping %}
    <table class="table table-bordered">
      <thead>
	<tr>
	  <th scope="col" style="width:300px">Attribute Name</th>
	  <th scope="col">Attribute Content</th>
	</tr>
      </thead>
      <tbody>
      {% for attr, attr_name in content.items() %}
	<tr>
	  <td>{{attr}}</td>
	  <td>{{attr_name}}</td>
	</tr>
      {% endfor %}
      </tbody>
    </table>
    {% else %}
    {{ content }}
    {% endif %}
    </div>
    </div>
  {% endfor %}
 </div>
 {% else %}
 {{output}}
  {% endif %}

   </div>
{% endblock %}
